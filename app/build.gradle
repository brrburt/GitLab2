/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details take a look at the 'Building Java & JVM projects' chapter in the Gradle
 * User Manual available at https://docs.gradle.org/7.2/userguide/building_java_projects.html
 */

plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
    id "org.xbib.gradle.plugin.git" version "2.0.0"
}

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // Use JUnit test framework.
    testImplementation 'junit:junit:4.13.2'

    // This dependency is used by the application.
    implementation 'com.google.guava:guava:30.1.1-jre'
}

application {
    // Define the main class for the application.
    mainClass = 'GitLab2.App'
}

test {
    ignoreFailures = true
}

task reports {
	test
	javadoc
}

task deployReports {
	reports
	doLast {
		// Clone gh-pages
		mkdir 'build/gh-pages'
		def thisRepo = rootProject.projectDir.toString()
		def pagesDir = "$buildDir/gh-pages"
		project.delete {
	    	delete pagesDir
	    }
		
		def grgit = git.clone {
	    	dir = pagesDir
	    	uri = 'file:' + thisRepo
	    	bare = false
	   		refToCheckout = 'gh-pages'
	     }
	     
	     grgit.checkout {
	     	branch = 'remotes/origin/gh-pages'
	     }
		
		// Copy docs and reports
		copy {
			from "$buildDir/docs"
			include "**/*"
			into "$buildDir/gh-pages/docs"
		}
		
		copy {
			from "$buildDir/reports"
			include "**/*"
			into "$buildDir/gh-pages/reports"
		}
		
		// Commit changes in docs and reports to gh-pages
		pagesDir = "$buildDir/gh-pages"
	    grgit = git.open {
	    	dir = pagesDir + "/.git"
	    }
	    grgit.add (update: false, patterns: ['reports/'])
	    grgit.add (update: true, patterns: ['reports/'])
	    
	    grgit.add (update: false, patterns: ['docs/'])
	    grgit.add (update: true, patterns: ['docs/'])
	    grgit.commit {
	    	message = "Updating web pages"
	    }
		grgit.push {}
	}
}